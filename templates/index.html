<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Richard's Cool Weather App</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/static/icon-180.png">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Richard's Cool Weather App</h1>
      <p class="subtitle">Get current weather and forecasts</p>
    </header>
    
    <main class="main-content">
      <div class="search-section">
        <div class="search-container">
          <input id="city" type="text" placeholder="Enter a city name..." class="search-input" />
          <div class="button-group">
            <button id="byCity" class="btn btn-primary">Search</button>
            <button id="byLocation" class="btn btn-secondary">üìç My Location</button>
            <button id="byHouse" class="btn btn-secondary">üè† House</button>
          </div>
        </div>
      </div>
      
      <div id="status" class="status"></div>
      
      <div id="current" class="weather-card current-weather"></div>
      
      <section class="satellite-section">
        <h2 class="section-title">Precipitation Radar</h2>
        <div id="satellite" class="satellite-container"></div>
      </section>
      
      <section class="hourly-forecast-section">
        <h2 class="section-title">24-Hour Forecast</h2>
        <div id="hourly-forecast" class="hourly-table-container"></div>
      </section>
      
      <section class="rainfall-section">
        <h2 class="section-title">24-Hour Rainfall</h2>
        <div id="rainfall-graph" class="rainfall-container"></div>
      </section>
      
      <section class="forecast-section">
        <h2 class="section-title">5-Day Forecast</h2>
        <div id="forecast" class="forecast-grid"></div>
      </section>
    </main>
  </div>

<script>
async function getJSON(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function fmtTemp(c){ return c != null ? `${c.toFixed(1)}¬∞C` : '‚Äî'; }
function fmtDate(iso){ try { return new Date(iso).toLocaleDateString(); } catch { return iso; } }

function formatHour(iso) {
  try {
    const date = new Date(iso);
    return date.toLocaleTimeString('en-GB', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false 
    });
  } catch {
    return iso;
  }
}

function getWindDirection(degrees) {
  if (degrees == null) return '';
  const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
  const index = Math.round(degrees / 22.5) % 16;
  return directions[index];
}

function getRainIntensity(probability, amount) {
  // Determine rain intensity based on both probability and amount
  if (probability >= 80 || amount >= 2.0) {
    return { icon: 'üåßÔ∏è', intensity: 'heavy' };
  } else if (probability >= 50 || amount >= 0.5) {
    return { icon: 'üå¶Ô∏è', intensity: 'moderate' };
  } else if (probability >= 20 || amount >= 0.1) {
    return { icon: 'üå§Ô∏è', intensity: 'light' };
  } else {
    return { icon: '‚òÄÔ∏è', intensity: 'none' };
  }
}

async function fetchByCity() {
  const city = document.getElementById('city').value.trim();
  if(!city){ setStatus('Please enter a city.'); return; }
  setStatus('Loading‚Ä¶');
  try {
    const data = await getJSON(`/api/weather?city=${encodeURIComponent(city)}`);
    render(data);
    setStatus('');
  } catch (e) {
    setStatus('City not found.');
  }
}

async function fetchByLocation() {
  if(!navigator.geolocation){ setStatus('Geolocation not available.'); return; }
  setStatus('Getting location‚Ä¶');
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const {latitude, longitude} = pos.coords;
    try {
      const data = await getJSON(`/api/weather?lat=${latitude}&lon=${longitude}`);
      render(data);
      setStatus('');
    } catch(e){
      setStatus('Failed to retrieve weather.');
    }
  }, () => setStatus('Location permission denied.'));
}

async function fetchByHouse() {
  setStatus('Loading weather for Newton Mearns‚Ä¶');
  try {
    const data = await getJSON(`/api/weather?city=Newton%20Mearns`);
    render(data);
    setStatus('');
  } catch (e) {
    setStatus('Failed to retrieve weather for Newton Mearns.');
  }
}

function setStatus(msg){
  document.getElementById('status').textContent = msg || '';
}

function render(data){
  const cur = data.current || {};
  const loc = data.location || {};
  const currentEl = document.getElementById('current');
  const satelliteEl = document.getElementById('satellite');
  const locText = loc.name ? `${loc.name}${loc.admin1? ', ' + loc.admin1 : ''}${loc.country? ', ' + loc.country : ''}`
                           : (loc.lat && loc.lon ? `Lat ${loc.lat.toFixed(2)}, Lon ${loc.lon.toFixed(2)}` : 'Unknown');
  
  currentEl.innerHTML = `
    <div class="current-header">
      <h2 class="location">${locText}</h2>
      <div class="current-time">${cur.time ? new Date(cur.time).toLocaleString() : '‚Äî'}</div>
    </div>
    <div class="current-details">
      <div class="temp-display">
        <div class="temp-main">${fmtTemp(cur.temperature_c)}</div>
        <div class="temp-secondary">${cur.temperature_f}¬∞F</div>
      </div>
      <div class="weather-stats">
        <div class="stat-item">
          <span class="stat-label">Wind</span>
          <span class="stat-value">${cur.windspeed ?? '‚Äî'} km/h</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Direction</span>
          <span class="stat-value">${cur.winddirection ?? '‚Äî'}¬∞</span>
        </div>
      </div>
    </div>
  `;

  // Render satellite imagery
  if (data.satellite_url) {
    satelliteEl.innerHTML = `
      <div class="satellite-card">
        <div class="satellite-info">
          <h3>Precipitation Radar - Live</h3>
          <p>Real-time precipitation radar showing weather patterns around ${locText}</p>
        </div>
        <div class="satellite-map">
          <iframe 
            src="${data.satellite_url}" 
            width="100%" 
            height="400" 
            frameborder="0" 
            scrolling="no"
            title="Precipitation Radar Map"
            onload="handleMapLoad(this)"
            onerror="handleMapError(this)">
          </iframe>
          <div class="map-loading" id="map-loading">
            <div class="loading-spinner"></div>
            <p>Loading precipitation radar...</p>
            <button class="retry-btn" onclick="retryMapLoad()">Retry</button>
          </div>
        </div>
        <div class="satellite-legend">
          <div class="legend-item">
            <span class="legend-color blue"></span>
            <span>Light Rain</span>
          </div>
          <div class="legend-item">
            <span class="legend-color green"></span>
            <span>Moderate Rain</span>
          </div>
          <div class="legend-item">
            <span class="legend-color yellow"></span>
            <span>Heavy Rain</span>
          </div>
          <div class="legend-item">
            <span class="legend-color red"></span>
            <span>Intense Rain</span>
          </div>
        </div>
        <div class="satellite-note">
          <p>üí° <strong>Tip:</strong> The radar shows precipitation intensity and movement. Blue areas indicate light rain, while red areas show heavy precipitation.</p>
          <p>üîÑ <strong>Alternative:</strong> If the radar doesn't load, you can <a href="${data.satellite_url}" target="_blank" class="external-link">open the weather map in a new tab</a>.</p>
        </div>
      </div>
    `;
  } else {
    satelliteEl.innerHTML = `
      <div class="satellite-card">
        <div class="satellite-info">
          <h3>Precipitation Radar</h3>
          <p>Satellite imagery not available for this location</p>
        </div>
      </div>
    `;
  }

  // Render 24-hour forecast table
  const hourlyEl = document.getElementById('hourly-forecast');
  const hourlyData = data.hourly_24h || [];
  
  if (hourlyData.length > 0) {
    hourlyEl.innerHTML = `
      <div class="hourly-table-card">
        <div class="hourly-cards">
          ${hourlyData.map(hour => {
            const hasRain = (hour.precipitation_probability || 0) > 20 || (hour.precipitation || 0) > 0.1;
            const rainIntensity = getRainIntensity(hour.precipitation_probability, hour.precipitation);
            
            return `
              <div class="hourly-card ${hasRain ? 'has-rain' : ''}">
                <div class="hour-time">${formatHour(hour.time)}</div>
                <div class="hour-temps">
                  <div class="hour-temp">${fmtTemp(hour.temperature_c)}</div>
                  <div class="hour-feels-like">Feels ${fmtTemp(hour.apparent_temperature_c)}</div>
                </div>
                <div class="hour-wind">
                  <div class="wind-icon">üí®</div>
                  <div class="wind-details">
                    <div class="wind-speed">${hour.wind_speed != null ? hour.wind_speed.toFixed(0) : '‚Äî'} km/h</div>
                    <div class="wind-direction">${hour.wind_direction != null ? getWindDirection(hour.wind_direction) : ''}</div>
                  </div>
                </div>
                <div class="hour-rain">
                  <div class="rain-icon">${rainIntensity.icon}</div>
                  <div class="rain-details">
                    <div class="rain-chance">${hour.precipitation_probability != null ? hour.precipitation_probability + '%' : '‚Äî'}</div>
                    <div class="rain-amount">${hour.precipitation != null ? hour.precipitation.toFixed(1) + ' mm' : '0.0 mm'}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  } else {
    hourlyEl.innerHTML = `
      <div class="hourly-table-card">
        <p class="no-data">Hourly forecast data not available</p>
      </div>
    `;
  }

  // Render rainfall graph
  const rainfallEl = document.getElementById('rainfall-graph');
  if (hourlyData.length > 0) {
    const maxRainfall = Math.max(...hourlyData.map(h => h.precipitation || 0));
    const graphHeight = 200;
    
    rainfallEl.innerHTML = `
      <div class="rainfall-card">
        <div class="rainfall-graph">
          <div class="graph-container">
            ${hourlyData.map((hour, index) => {
              const height = maxRainfall > 0 ? (hour.precipitation || 0) / maxRainfall * graphHeight : 0;
              const rainIntensity = getRainIntensity(hour.precipitation_probability, hour.precipitation);
              return `
                <div class="rainfall-bar ${rainIntensity.intensity}" style="height: ${height}px">
                  <div class="bar-tooltip">
                    <div class="tooltip-time">${formatHour(hour.time)}</div>
                    <div class="tooltip-rain">${hour.precipitation != null ? hour.precipitation.toFixed(1) + ' mm' : '0 mm'}</div>
                    <div class="tooltip-chance">${hour.precipitation_probability != null ? hour.precipitation_probability + '% chance' : '‚Äî'}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="graph-labels">
            ${hourlyData.map((hour, index) => `
              <div class="time-label">${index % 4 === 0 ? formatHour(hour.time) : ''}</div>
            `).join('')}
          </div>
        </div>
        <div class="rainfall-summary">
          <div class="summary-item">
            <span class="summary-label">Total Rainfall:</span>
            <span class="summary-value">${hourlyData.reduce((sum, hour) => sum + (hour.precipitation || 0), 0).toFixed(1)} mm</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Max Hourly:</span>
            <span class="summary-value">${Math.max(...hourlyData.map(h => h.precipitation || 0)).toFixed(1)} mm</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Rainy Hours:</span>
            <span class="summary-value">${hourlyData.filter(h => (h.precipitation || 0) > 0.1).length} hours</span>
          </div>
        </div>
      </div>
    `;
  } else {
    rainfallEl.innerHTML = `
      <div class="rainfall-card">
        <p class="no-data">Rainfall data not available</p>
      </div>
    `;
  }

  const fc = data.daily || {};
  const days = (fc.time || []).map((t, i) => ({
    date: t,
    tmax: fc.tmax_c?.[i],
    tmin: fc.tmin_c?.[i],
    precip: fc.precip_sum_mm?.[i],
    wind: fc.wind_max?.[i]
  }));

  const forecastEl = document.getElementById('forecast');
  forecastEl.innerHTML = days.map(d => `
    <div class="forecast-card">
      <div class="forecast-date">${fmtDate(d.date)}</div>
      <div class="forecast-temps">
        <div class="temp-high">${fmtTemp(d.tmax)}</div>
        <div class="temp-low">${fmtTemp(d.tmin)}</div>
      </div>
      <div class="forecast-details">
        <div class="detail-item">
          <span class="detail-icon">üíß</span>
          <span class="detail-value">${d.precip != null ? d.precip.toFixed(1) + ' mm' : '‚Äî'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üí®</span>
          <span class="detail-value">${d.wind != null ? d.wind.toFixed(0) + ' km/h' : '‚Äî'}</span>
        </div>
      </div>
    </div>
  `).join('');
}

document.getElementById('byCity').addEventListener('click', fetchByCity);
document.getElementById('byLocation').addEventListener('click', fetchByLocation);
document.getElementById('byHouse').addEventListener('click', fetchByHouse);

// Handle map loading and errors
let mapLoadTimeout;

function handleMapLoad(iframe) {
  clearTimeout(mapLoadTimeout);
  const loadingDiv = iframe.parentElement.querySelector('.map-loading');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
  iframe.style.opacity = '1';
}

function handleMapError(iframe) {
  clearTimeout(mapLoadTimeout);
  const mapContainer = iframe.parentElement;
  const loadingDiv = mapContainer.querySelector('.map-loading');
  
  if (loadingDiv) {
    loadingDiv.innerHTML = `
      <div class="map-error">
        <div class="error-icon">üåßÔ∏è</div>
        <h4>Radar Unavailable</h4>
        <p>Precipitation radar is currently unavailable for this location.</p>
        <p>Please try again later or check the weather forecast above.</p>
        <button class="retry-btn" onclick="retryMapLoad()">Try Again</button>
      </div>
    `;
  }
}

function retryMapLoad() {
  const iframe = document.querySelector('.satellite-map iframe');
  if (iframe) {
    const loadingDiv = iframe.parentElement.querySelector('.map-loading');
    if (loadingDiv) {
      loadingDiv.innerHTML = `
        <div class="loading-spinner"></div>
        <p>Loading precipitation radar...</p>
        <button class="retry-btn" onclick="retryMapLoad()">Retry</button>
      </div>
    `;
    }
    iframe.src = iframe.src; // Reload the iframe
    startMapLoadTimeout();
  }
}

function startMapLoadTimeout() {
  mapLoadTimeout = setTimeout(() => {
    const iframe = document.querySelector('.satellite-map iframe');
    const loadingDiv = document.getElementById('map-loading');
    if (loadingDiv && iframe.style.opacity !== '1') {
      loadingDiv.innerHTML = `
        <div class="map-error">
          <div class="error-icon">‚è∞</div>
          <h4>Loading Timeout</h4>
          <p>The radar map is taking longer than expected to load.</p>
          <button class="retry-btn" onclick="retryMapLoad()">Try Again</button>
        </div>
      `;
    }
  }, 15000); // 15 second timeout
}

// Start timeout when page loads
window.addEventListener('load', function() {
  startMapLoadTimeout();
});

// Attempt to load by location on first visit for convenience
fetchByLocation();
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function() {
    navigator.serviceWorker.register("/static/service-worker.js");
  });
}
</script>
</body>
</html>