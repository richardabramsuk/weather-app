<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Richard's Cool Weather App</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/static/icon-180.png">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Richard's Cool Weather App</h1>
      <p class="subtitle">Get current weather and forecasts</p>
    </header>
    
    <main class="main-content">
      <div class="search-section">
        <div class="search-container">
          <input id="city" type="text" placeholder="Enter a city name..." class="search-input" />
          <div class="button-group">
            <button id="byCity" class="btn btn-primary">Search</button>
            <button id="byLocation" class="btn btn-secondary">üìç My Location</button>
            <button id="byHouse" class="btn btn-secondary">üè† House</button>
          </div>
        </div>
      </div>
      
      <div id="status" class="status"></div>
      
      <div id="current" class="weather-card current-weather"></div>
      
      <section class="forecast-section">
        <h2 class="section-title">5-Day Forecast</h2>
        <div id="forecast" class="forecast-grid"></div>
      </section>
    </main>
  </div>

<script>
async function getJSON(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function fmtTemp(c){ return c != null ? `${c.toFixed(1)}¬∞C` : '‚Äî'; }
function fmtDate(iso){ try { return new Date(iso).toLocaleDateString(); } catch { return iso; } }

async function fetchByCity() {
  const city = document.getElementById('city').value.trim();
  if(!city){ setStatus('Please enter a city.'); return; }
  setStatus('Loading‚Ä¶');
  try {
    const data = await getJSON(`/api/weather?city=${encodeURIComponent(city)}`);
    render(data);
    setStatus('');
  } catch (e) {
    setStatus('City not found.');
  }
}

async function fetchByLocation() {
  if(!navigator.geolocation){ setStatus('Geolocation not available.'); return; }
  setStatus('Getting location‚Ä¶');
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const {latitude, longitude} = pos.coords;
    try {
      const data = await getJSON(`/api/weather?lat=${latitude}&lon=${longitude}`);
      render(data);
      setStatus('');
    } catch(e){
      setStatus('Failed to retrieve weather.');
    }
  }, () => setStatus('Location permission denied.'));
}

async function fetchByHouse() {
  setStatus('Loading weather for Newton Mearns‚Ä¶');
  try {
    const data = await getJSON(`/api/weather?city=Newton%20Mearns`);
    render(data);
    setStatus('');
  } catch (e) {
    setStatus('Failed to retrieve weather for Newton Mearns.');
  }
}

function setStatus(msg){
  document.getElementById('status').textContent = msg || '';
}

function render(data){
  const cur = data.current || {};
  const loc = data.location || {};
  const currentEl = document.getElementById('current');
  const locText = loc.name ? `${loc.name}${loc.admin1? ', ' + loc.admin1 : ''}${loc.country? ', ' + loc.country : ''}`
                           : (loc.lat && loc.lon ? `Lat ${loc.lat.toFixed(2)}, Lon ${loc.lon.toFixed(2)}` : 'Unknown');
  
  currentEl.innerHTML = `
    <div class="current-header">
      <h2 class="location">${locText}</h2>
      <div class="current-time">${cur.time ? new Date(cur.time).toLocaleString() : '‚Äî'}</div>
    </div>
    <div class="current-details">
      <div class="temp-display">
        <div class="temp-main">${fmtTemp(cur.temperature_c)}</div>
        <div class="temp-secondary">${cur.temperature_f}¬∞F</div>
      </div>
      <div class="weather-stats">
        <div class="stat-item">
          <span class="stat-label">Wind</span>
          <span class="stat-value">${cur.windspeed ?? '‚Äî'} km/h</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Direction</span>
          <span class="stat-value">${cur.winddirection ?? '‚Äî'}¬∞</span>
        </div>
      </div>
    </div>
  `;

  const fc = data.daily || {};
  const days = (fc.time || []).map((t, i) => ({
    date: t,
    tmax: fc.tmax_c?.[i],
    tmin: fc.tmin_c?.[i],
    precip: fc.precip_sum_mm?.[i],
    wind: fc.wind_max?.[i]
  }));

  const forecastEl = document.getElementById('forecast');
  forecastEl.innerHTML = days.map(d => `
    <div class="forecast-card">
      <div class="forecast-date">${fmtDate(d.date)}</div>
      <div class="forecast-temps">
        <div class="temp-high">${fmtTemp(d.tmax)}</div>
        <div class="temp-low">${fmtTemp(d.tmin)}</div>
      </div>
      <div class="forecast-details">
        <div class="detail-item">
          <span class="detail-icon">üíß</span>
          <span class="detail-value">${d.precip != null ? d.precip.toFixed(1) + ' mm' : '‚Äî'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-icon">üí®</span>
          <span class="detail-value">${d.wind != null ? d.wind.toFixed(0) + ' km/h' : '‚Äî'}</span>
        </div>
      </div>
    </div>
  `).join('');
}

document.getElementById('byCity').addEventListener('click', fetchByCity);
document.getElementById('byLocation').addEventListener('click', fetchByLocation);
document.getElementById('byHouse').addEventListener('click', fetchByHouse);

// Attempt to load by location on first visit for convenience
fetchByLocation();
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function() {
    navigator.serviceWorker.register("/static/service-worker.js");
  });
}
</script>
</body>
</html>