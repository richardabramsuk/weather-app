<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Richard's Cool Weather App</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/static/icon-180.png">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Richard's Cool Weather App</h1>
      <p class="subtitle">Get current weather and forecasts</p>
    </header>
    
    <div class="section-navigation">
      <button class="nav-btn" data-section="current">ğŸŒ¤ï¸ Now</button>
      <button class="nav-btn active" data-section="satellite">ğŸŒ§ï¸ Radar</button>
      <button class="nav-btn" data-section="hourly-forecast">â° 24h Forecast</button>
      <button class="nav-btn" data-section="rainfall-graph">ğŸ“Š Rainfall</button>
      <button class="nav-btn" data-section="forecast">ğŸ“… 5-Day</button>
      <button class="nav-btn" data-section="travel">ğŸš— Travel</button>
      <button class="nav-btn scroll-top" onclick="scrollToTop()">â¬†ï¸ Top</button>
    </div>
    
    <main class="main-content">
      <div class="search-section">
        <div class="search-container">
          <input id="city" type="text" placeholder="Enter a city name..." class="search-input" />
          <div class="button-group">
            <button id="byCity" class="btn btn-primary">Search</button>
            <button id="byLocation" class="btn btn-secondary">ğŸ“ My Location</button>
            <button id="byHouse" class="btn btn-secondary">ğŸ  House</button>
            <button id="workTravel" class="btn btn-secondary">ğŸš— Work Travel</button>
          </div>
        </div>
      </div>
      
      <div id="status" class="status"></div>
      
      <div id="current" class="weather-card current-weather"></div>
      
      <section class="satellite-section">
        <h2 class="section-title">Precipitation Radar</h2>
        <div id="satellite" class="satellite-container"></div>
      </section>
      
      <section class="hourly-forecast-section">
        <h2 class="section-title">24-Hour Forecast</h2>
        <div id="hourly-forecast" class="hourly-table-container"></div>
      </section>
      
      <section class="travel-section" id="travel-section" style="display: none;">
        <h2 class="section-title">Work Travel</h2>
        <div id="travel-info" class="travel-container"></div>
      </section>
      
      <section class="rainfall-section">
        <h2 class="section-title">24-Hour Rainfall</h2>
        <div id="rainfall-graph" class="rainfall-container"></div>
      </section>
      
      <section class="forecast-section">
        <h2 class="section-title">5-Day Forecast</h2>
        <div id="forecast" class="forecast-grid"></div>
      </section>
    </main>
  </div>

<script>
async function getJSON(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function fmtTemp(c){ return c != null ? `${c.toFixed(1)}Â°C` : 'â€”'; }
function fmtDate(iso){ try { return new Date(iso).toLocaleDateString(); } catch { return iso; } }

function formatHour(iso) {
  try {
    const date = new Date(iso);
    return date.toLocaleTimeString('en-GB', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false 
    });
  } catch {
    return iso;
  }
}

function getWindDirection(degrees) {
  if (degrees == null) return '';
  const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
  const index = Math.round(degrees / 22.5) % 16;
  return directions[index];
}

function getRainIntensity(probability, amount) {
  // Determine rain intensity based on both probability and amount
  if (probability >= 80 || amount >= 2.0) {
    return { icon: 'ğŸŒ§ï¸', intensity: 'heavy' };
  } else if (probability >= 50 || amount >= 0.5) {
    return { icon: 'ğŸŒ¦ï¸', intensity: 'moderate' };
  } else if (probability >= 20 || amount >= 0.1) {
    return { icon: 'ğŸŒ¤ï¸', intensity: 'light' };
  } else {
    return { icon: 'â˜€ï¸', intensity: 'none' };
  }
}

function getWeatherDescription(weathercode) {
  const descriptions = {
    0: 'â˜€ï¸ Clear sky',
    1: 'ğŸŒ¤ï¸ Mainly clear',
    2: 'â›… Partly cloudy',
    3: 'â˜ï¸ Overcast',
    45: 'ğŸŒ«ï¸ Foggy',
    48: 'ğŸŒ«ï¸ Depositing rime fog',
    51: 'ğŸŒ¦ï¸ Light drizzle',
    53: 'ğŸŒ¦ï¸ Moderate drizzle',
    55: 'ğŸŒ¦ï¸ Dense drizzle',
    56: 'ğŸŒ§ï¸ Light freezing drizzle',
    57: 'ğŸŒ§ï¸ Dense freezing drizzle',
    61: 'ğŸŒ§ï¸ Slight rain',
    63: 'ğŸŒ§ï¸ Moderate rain',
    65: 'ğŸŒ§ï¸ Heavy rain',
    66: 'ğŸŒ§ï¸ Light freezing rain',
    67: 'ğŸŒ§ï¸ Heavy freezing rain',
    71: 'ğŸŒ¨ï¸ Slight snow',
    73: 'ğŸŒ¨ï¸ Moderate snow',
    75: 'ğŸŒ¨ï¸ Heavy snow',
    77: 'ğŸŒ¨ï¸ Snow grains',
    80: 'ğŸŒ¦ï¸ Slight rain showers',
    81: 'ğŸŒ§ï¸ Moderate rain showers',
    82: 'ğŸŒ§ï¸ Violent rain showers',
    85: 'ğŸŒ¨ï¸ Slight snow showers',
    86: 'ğŸŒ¨ï¸ Heavy snow showers',
    95: 'â›ˆï¸ Thunderstorm',
    96: 'â›ˆï¸ Thunderstorm with slight hail',
    99: 'â›ˆï¸ Thunderstorm with heavy hail'
  };
  return descriptions[weathercode] || 'ğŸŒ¤ï¸ Partly cloudy';
}

function generateRainForecast(hourlyData) {
  if (!hourlyData || hourlyData.length === 0) {
    return '<div class="no-rain-data">No rain forecast data available</div>';
  }

  const currentHour = new Date().getHours();
  const nextRain = hourlyData.find((hour, index) => {
    const hourTime = new Date(hour.time).getHours();
    return hour.precipitation > 0.1 || hour.precipitation_probability > 20;
  });

  const currentRain = hourlyData.find(hour => {
    const hourTime = new Date(hour.time).getHours();
    return hourTime === currentHour && (hour.precipitation > 0.1 || hour.precipitation_probability > 20);
  });

  const dryTime = hourlyData.find((hour, index) => {
    const hourTime = new Date(hour.time).getHours();
    return hourTime > currentHour && hour.precipitation <= 0.1 && hour.precipitation_probability <= 20;
  });

  let forecastHTML = '<div class="rain-info">';
  
  if (currentRain) {
    const intensity = getRainIntensity(currentRain.precipitation_probability, currentRain.precipitation);
    forecastHTML += `
      <div class="current-rain">
        <div class="rain-icon">${intensity.icon}</div>
        <div class="rain-details">
          <div class="rain-status">Currently raining</div>
          <div class="rain-intensity">${getRainIntensityText(currentRain.precipitation)}</div>
        </div>
      </div>
    `;
  }

  if (nextRain && !currentRain) {
    const hoursUntilRain = new Date(nextRain.time).getHours() - currentHour;
    const intensity = getRainIntensity(nextRain.precipitation_probability, nextRain.precipitation);
    forecastHTML += `
      <div class="next-rain">
        <div class="rain-icon">${intensity.icon}</div>
        <div class="rain-details">
          <div class="rain-status">Rain in ${hoursUntilRain} hour${hoursUntilRain !== 1 ? 's' : ''}</div>
          <div class="rain-intensity">${getRainIntensityText(nextRain.precipitation)} expected</div>
        </div>
      </div>
    `;
  }

  if (dryTime && (currentRain || nextRain)) {
    const hoursUntilDry = new Date(dryTime.time).getHours() - currentHour;
    forecastHTML += `
      <div class="dry-time">
        <div class="dry-icon">â˜€ï¸</div>
        <div class="dry-details">
          <div class="dry-status">Dry in ${hoursUntilDry} hour${hoursUntilDry !== 1 ? 's' : ''}</div>
        </div>
      </div>
    `;
  }

  if (!currentRain && !nextRain) {
    forecastHTML += `
      <div class="no-rain">
        <div class="no-rain-icon">â˜€ï¸</div>
        <div class="no-rain-details">
          <div class="no-rain-status">No rain expected</div>
        </div>
      </div>
    `;
  }

  forecastHTML += '</div>';
  return forecastHTML;
}

function getRainIntensityText(amount) {
  if (amount >= 2.0) return 'Heavy rain';
  if (amount >= 0.5) return 'Moderate rain';
  if (amount >= 0.1) return 'Light rain';
  return 'Drizzle';
}

async function fetchByCity() {
  const city = document.getElementById('city').value.trim();
  if(!city){ setStatus('Please enter a city.'); return; }
  setStatus('Loadingâ€¦');
  try {
    const data = await getJSON(`/api/weather?city=${encodeURIComponent(city)}`);
    render(data);
    setStatus('');
  } catch (e) {
    console.error('Weather fetch error:', e);
    if (e.message.includes('404')) {
      setStatus('City not found.');
    } else if (e.message.includes('500')) {
      setStatus('Server error. Please try again.');
    } else {
      setStatus('Failed to retrieve weather. Please try again.');
    }
  }
}

async function fetchByLocation() {
  if(!navigator.geolocation){ setStatus('Geolocation not available.'); return; }
  setStatus('Getting locationâ€¦');
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const {latitude, longitude} = pos.coords;
    try {
      const data = await getJSON(`/api/weather?lat=${latitude}&lon=${longitude}`);
      render(data);
      setStatus('');
    } catch(e){
      console.error('Location weather error:', e);
      setStatus('Failed to retrieve weather for your location.');
    }
  }, () => setStatus('Location permission denied.'));
}

async function fetchByHouse() {
  setStatus('Loading weather for Newton Mearnsâ€¦');
  try {
    const data = await getJSON(`/api/weather?city=Newton%20Mearns`);
    render(data);
    setStatus('');
  } catch (e) {
    console.error('House weather error:', e);
    setStatus('Failed to retrieve weather for Newton Mearns.');
  }
}

async function fetchWorkTravel() {
  console.log('Work Travel button clicked');
  setStatus('Loading travel informationâ€¦');
  try {
    const data = await getJSON(`/api/travel?from=G77%205PG&to=KICK%20ICT`);
    console.log('Travel data received:', data);
    renderTravel(data);
    setStatus('');
  } catch (e) {
    console.error('Travel error:', e);
    setStatus('Failed to retrieve travel information.');
  }
}

function setStatus(msg){
  document.getElementById('status').textContent = msg || '';
}

function render(data){
  const cur = data.current || {};
  const loc = data.location || {};
  const hourlyData = data.hourly_24h || [];
  const currentEl = document.getElementById('current');
  const satelliteEl = document.getElementById('satellite');
  const locText = loc.name ? `${loc.name}${loc.admin1? ', ' + loc.admin1 : ''}${loc.country? ', ' + loc.country : ''}`
                           : (loc.lat && loc.lon ? `Lat ${loc.lat.toFixed(2)}, Lon ${loc.lon.toFixed(2)}` : 'Unknown');
  
  currentEl.innerHTML = `
    <div class="current-header">
      <h2 class="location">${locText}</h2>
      <div class="current-time">${cur.time ? new Date(cur.time).toLocaleString() : 'â€”'}</div>
    </div>
    <div class="current-details">
      <div class="temp-display">
        <div class="temp-main">${fmtTemp(cur.temperature_c)}</div>
        <div class="temp-secondary">${cur.temperature_f}Â°F</div>
        <div class="weather-description">${getWeatherDescription(cur.weathercode)}</div>
        <div class="feels-like">Feels like ${fmtTemp(cur.apparent_temperature_c)}</div>
      </div>
      <div class="weather-stats">
        <div class="stat-item">
          <span class="stat-label">Wind</span>
          <span class="stat-value">${cur.windspeed ?? 'â€”'} km/h</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Direction</span>
          <span class="stat-value">${cur.winddirection ?? 'â€”'}Â°</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Humidity</span>
          <span class="stat-value">${cur.relative_humidity ?? 'â€”'}%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Rain</span>
          <span class="stat-value">${cur.precipitation ?? '0'} mm</span>
        </div>
      </div>
    </div>
    <div class="rain-forecast">
      ${generateRainForecast(hourlyData)}
    </div>
  `;

  // Render satellite imagery
  if (data.satellite_url) {
    satelliteEl.innerHTML = `
      <div class="satellite-card">
        <div class="satellite-info">
          <h3>Precipitation Radar - Live</h3>
          <p>Real-time precipitation radar showing weather patterns around ${locText}</p>
        </div>
        <div class="satellite-map">
          <iframe 
            src="${data.satellite_url}" 
            width="100%" 
            height="400" 
            frameborder="0" 
            scrolling="no"
            title="Precipitation Radar Map"
            onload="handleMapLoad(this)"
            onerror="handleMapError(this)">
          </iframe>
          <div class="map-loading" id="map-loading">
            <div class="loading-spinner"></div>
            <p>Loading precipitation radar...</p>
            <button class="retry-btn" onclick="retryMapLoad()">Retry</button>
          </div>
        </div>
        <div class="satellite-legend">
          <div class="legend-item">
            <span class="legend-color blue"></span>
            <span>Light Rain</span>
          </div>
          <div class="legend-item">
            <span class="legend-color green"></span>
            <span>Moderate Rain</span>
          </div>
          <div class="legend-item">
            <span class="legend-color yellow"></span>
            <span>Heavy Rain</span>
          </div>
          <div class="legend-item">
            <span class="legend-color red"></span>
            <span>Intense Rain</span>
          </div>
        </div>
        <div class="satellite-note">
          <p>ğŸ’¡ <strong>Tip:</strong> The radar shows precipitation intensity and movement. Blue areas indicate light rain, while red areas show heavy precipitation.</p>
          <p>ğŸ”„ <strong>Alternative:</strong> If the radar doesn't load, you can <a href="${data.satellite_url}" target="_blank" class="external-link">open the weather map in a new tab</a>.</p>
        </div>
      </div>
    `;
  } else {
    satelliteEl.innerHTML = `
      <div class="satellite-card">
        <div class="satellite-info">
          <h3>Precipitation Radar</h3>
          <p>Satellite imagery not available for this location</p>
        </div>
      </div>
    `;
  }

  // Render 24-hour forecast table
  const hourlyEl = document.getElementById('hourly-forecast');
  
  if (hourlyData.length > 0) {
    hourlyEl.innerHTML = `
      <div class="hourly-table-card">
        <div class="hourly-cards">
          ${hourlyData.map(hour => {
            const hasRain = (hour.precipitation_probability || 0) > 20 || (hour.precipitation || 0) > 0.1;
            const rainIntensity = getRainIntensity(hour.precipitation_probability, hour.precipitation);
            
            return `
              <div class="hourly-card ${hasRain ? 'has-rain' : ''}">
                <div class="hour-time">${formatHour(hour.time)}</div>
                <div class="hour-temps">
                  <div class="hour-temp">${fmtTemp(hour.temperature_c)}</div>
                  <div class="hour-feels-like">Feels ${fmtTemp(hour.apparent_temperature_c)}</div>
                </div>
                <div class="hour-wind">
                  <div class="wind-icon">ğŸ’¨</div>
                  <div class="wind-details">
                    <div class="wind-speed">${hour.wind_speed != null ? hour.wind_speed.toFixed(0) : 'â€”'} km/h</div>
                    <div class="wind-direction">${hour.wind_direction != null ? getWindDirection(hour.wind_direction) : ''}</div>
                  </div>
                </div>
                <div class="hour-rain">
                  <div class="rain-icon">${rainIntensity.icon}</div>
                  <div class="rain-details">
                    <div class="rain-chance">${hour.precipitation_probability != null ? hour.precipitation_probability + '%' : 'â€”'}</div>
                    <div class="rain-amount">${hour.precipitation != null ? hour.precipitation.toFixed(1) + ' mm' : '0.0 mm'}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  } else {
    hourlyEl.innerHTML = `
      <div class="hourly-table-card">
        <p class="no-data">Hourly forecast data not available</p>
      </div>
    `;
  }

  // Render rainfall graph
  const rainfallEl = document.getElementById('rainfall-graph');
  if (hourlyData.length > 0) {
    const maxRainfall = Math.max(...hourlyData.map(h => h.precipitation || 0));
    const graphHeight = 150;
    
    rainfallEl.innerHTML = `
      <div class="rainfall-card">
        <div class="rainfall-graph">
          <div class="graph-container">
            ${hourlyData.map((hour, index) => {
              const height = maxRainfall > 0 ? (hour.precipitation || 0) / maxRainfall * graphHeight : 0;
              const rainIntensity = getRainIntensity(hour.precipitation_probability, hour.precipitation);
              return `
                <div class="rainfall-bar ${rainIntensity.intensity}" style="height: ${height}px">
                  <div class="bar-tooltip">
                    <div class="tooltip-time">${formatHour(hour.time)}</div>
                    <div class="tooltip-rain">${hour.precipitation != null ? hour.precipitation.toFixed(1) + ' mm' : '0 mm'}</div>
                    <div class="tooltip-chance">${hour.precipitation_probability != null ? hour.precipitation_probability + '% chance' : 'â€”'}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="graph-labels">
            ${hourlyData.map((hour, index) => `
              <div class="time-label">${index % 4 === 0 ? formatHour(hour.time) : ''}</div>
            `).join('')}
          </div>
        </div>
        <div class="rainfall-summary">
          <div class="summary-item">
            <span class="summary-label">Total Rainfall:</span>
            <span class="summary-value">${hourlyData.reduce((sum, hour) => sum + (hour.precipitation || 0), 0).toFixed(1)} mm</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Max Hourly:</span>
            <span class="summary-value">${Math.max(...hourlyData.map(h => h.precipitation || 0)).toFixed(1)} mm</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Rainy Hours:</span>
            <span class="summary-value">${hourlyData.filter(h => (h.precipitation || 0) > 0.1).length} hours</span>
          </div>
        </div>
      </div>
    `;
  } else {
    rainfallEl.innerHTML = `
      <div class="rainfall-card">
        <p class="no-data">Rainfall data not available</p>
      </div>
    `;
  }

  const fc = data.daily || {};
  const days = (fc.time || []).map((t, i) => ({
    date: t,
    tmax: fc.tmax_c?.[i],
    tmin: fc.tmin_c?.[i],
    precip: fc.precip_sum_mm?.[i],
    wind: fc.wind_max?.[i]
  }));

  const forecastEl = document.getElementById('forecast');
  forecastEl.innerHTML = days.map(d => `
    <div class="forecast-card">
      <div class="forecast-date">${fmtDate(d.date)}</div>
      <div class="forecast-temps">
        <div class="temp-high">${fmtTemp(d.tmax)}</div>
        <div class="temp-low">${fmtTemp(d.tmin)}</div>
        <div class="temp-feels-like">Feels like ${fmtTemp(d.tmax)}</div>
      </div>
      <div class="forecast-details">
        <div class="detail-item">
          <span class="detail-icon">ğŸ’§</span>
          <span class="detail-value">${d.precip != null ? d.precip.toFixed(1) + ' mm' : 'â€”'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-icon">ğŸ’¨</span>
          <span class="detail-value">${d.wind != null ? d.wind.toFixed(0) + ' km/h' : 'â€”'}</span>
        </div>
      </div>
    </div>
  `).join('');
}

function renderTravel(data) {
  console.log('Rendering travel data:', data);
  const travelEl = document.getElementById('travel-info');
  const travelSection = document.getElementById('travel-section');
  
  console.log('Travel elements found:', { travelEl, travelSection });
  
  // Show the travel section
  if (travelSection) {
    travelSection.style.display = 'block';
    console.log('Travel section shown');
  }
  
  if (data && data.routes) {
    travelEl.innerHTML = `
      <div class="travel-card">
        <div class="travel-header">
          <div class="header-left">
            <h3>ğŸš— G77 5PG â†’ KICK ICT</h3>
            <div class="travel-time">
              <span class="time-main">${data.routes.outbound.duration}</span>
              <span class="time-traffic">${data.routes.outbound.traffic_status}</span>
            </div>
          </div>
          <div class="header-right">
            <div class="map-controls">
              <a href="https://www.google.com/maps/dir/G77+5PG/KICK+ICT" target="_blank" class="map-link">
                ğŸ—ºï¸ To Work
              </a>
              <a href="https://www.google.com/maps/dir/KICK+ICT/G77+5PG" target="_blank" class="map-link secondary">
                ğŸ  To Home
              </a>
            </div>
          </div>
        </div>
        
        <div class="travel-map">
          <div class="map-container">
            <div class="route-map">
              <div class="map-header">
                <div class="route-line">
                  <div class="start-point">ğŸ </div>
                  <div class="route-path">
                    <div class="traffic-indicator moderate"></div>
                  </div>
                  <div class="end-point">ğŸ¢</div>
                </div>
                <div class="route-stats">
                  <div class="stat">12.3 km</div>
                  <div class="stat">25 min</div>
                </div>
              </div>
              
              <div class="map-visual">
                <div class="map-area">
                  <div class="location start">G77 5PG</div>
                  <div class="route-visual">
                    <div class="road-segment normal"></div>
                    <div class="road-segment slow" title="M77 - Slow traffic"></div>
                    <div class="road-segment normal"></div>
                    <div class="road-segment minor-delay" title="A77 - Minor delays"></div>
                    <div class="road-segment normal"></div>
                  </div>
                  <div class="location end">KICK ICT</div>
                </div>
                
                <div class="traffic-legend">
                  <div class="legend-item">
                    <div class="legend-color normal"></div>
                    <span>Normal</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color slow"></div>
                    <span>Slow</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color delay"></div>
                    <span>Delays</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          

        </div>
        
        <div class="travel-details">
          <div class="route-info">
            <div class="route-item">
              <span class="route-label">Distance:</span>
              <span class="route-value">${data.routes.outbound.distance}</span>
            </div>
            <div class="route-item">
              <span class="route-label">Duration:</span>
              <span class="route-value">${data.routes.outbound.duration}</span>
            </div>
            <div class="route-item">
              <span class="route-label">Traffic:</span>
              <span class="route-value traffic-${data.routes.outbound.traffic_level}">${data.routes.outbound.traffic_status}</span>
            </div>
          </div>
          
          <div class="traffic-alerts">
            ${data.routes.outbound.alerts.map(alert => `
              <div class="alert-item ${alert.severity}">
                <span class="alert-icon">âš ï¸</span>
                <span class="alert-text">${alert.description}</span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="return-route">
          <h4>ğŸ”„ Return Journey: KICK ICT â†’ G77 5PG</h4>
          <div class="return-info">
            <div class="return-item">
              <span class="return-label">Duration:</span>
              <span class="return-value">${data.routes.return.duration}</span>
            </div>
            <div class="return-item">
              <span class="return-label">Traffic:</span>
              <span class="return-value traffic-${data.routes.return.traffic_level}">${data.routes.return.traffic_status}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  } else {
    if (travelEl) {
      travelEl.innerHTML = `
        <div class="travel-card">
          <div class="travel-error">
            <div class="error-icon">ğŸš—</div>
            <h4>Travel Information Unavailable</h4>
            <p>Unable to load travel information at this time.</p>
            <a href="https://www.google.com/maps/dir/G77+5PG/KICK+ICT" target="_blank" class="map-link">
              Check Route on Google Maps
            </a>
          </div>
        </div>
      `;
    }
  }
  
  // Scroll to travel section
  if (travelSection) {
    travelSection.scrollIntoView({ behavior: 'smooth' });
  }
}

document.getElementById('byCity').addEventListener('click', fetchByCity);
document.getElementById('byLocation').addEventListener('click', fetchByLocation);
document.getElementById('byHouse').addEventListener('click', fetchByHouse);
// Check if work travel button exists and add event listener
const workTravelBtn = document.getElementById('workTravel');
if (workTravelBtn) {
  console.log('Work Travel button found, adding event listener');
  workTravelBtn.addEventListener('click', function() {
    console.log('Work Travel button clicked - event listener working');
    fetchWorkTravel();
  });
} else {
  console.error('Work Travel button not found!');
}

// Section navigation functionality
document.addEventListener('DOMContentLoaded', function() {
  const navBtns = document.querySelectorAll('.nav-btn');
  const sections = {
    'current': document.querySelector('#current'),
    'satellite': document.querySelector('.satellite-section'),
    'hourly-forecast': document.querySelector('.hourly-forecast-section'),
    'rainfall-graph': document.querySelector('.rainfall-section'),
    'forecast': document.querySelector('.forecast-section'),
    'travel': document.querySelector('.travel-section')
  };

  navBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const targetSection = this.getAttribute('data-section');
      
      // Skip if it's the scroll-to-top button
      if (this.classList.contains('scroll-top')) {
        return;
      }
      
      // Update active button
      navBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // Scroll to section
      if (sections[targetSection]) {
        const element = sections[targetSection];
        const navHeight = document.querySelector('.section-navigation').offsetHeight;
        const elementPosition = element.offsetTop - navHeight - 20; // 20px extra padding
        
        window.scrollTo({
          top: elementPosition,
          behavior: 'smooth'
        });
      }
    });
  });
  
  // Auto-load home location on app start
  fetchByHouse();
});

// Scroll to top function
function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
}

// Handle map loading and errors
let mapLoadTimeout;

function handleMapLoad(iframe) {
  clearTimeout(mapLoadTimeout);
  const loadingDiv = iframe.parentElement.querySelector('.map-loading');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
  iframe.style.opacity = '1';
}

function handleMapError(iframe) {
  clearTimeout(mapLoadTimeout);
  const mapContainer = iframe.parentElement;
  const loadingDiv = mapContainer.querySelector('.map-loading');
  
  if (loadingDiv) {
    loadingDiv.innerHTML = `
      <div class="map-error">
        <div class="error-icon">ğŸŒ§ï¸</div>
        <h4>Radar Unavailable</h4>
        <p>Precipitation radar is currently unavailable for this location.</p>
        <p>Please try again later or check the weather forecast above.</p>
        <button class="retry-btn" onclick="retryMapLoad()">Try Again</button>
      </div>
    `;
  }
}

function retryMapLoad() {
  const iframe = document.querySelector('.satellite-map iframe');
  if (iframe) {
    const loadingDiv = iframe.parentElement.querySelector('.map-loading');
    if (loadingDiv) {
      loadingDiv.innerHTML = `
        <div class="loading-spinner"></div>
        <p>Loading precipitation radar...</p>
        <button class="retry-btn" onclick="retryMapLoad()">Retry</button>
      </div>
    `;
    }
    iframe.src = iframe.src; // Reload the iframe
    startMapLoadTimeout();
  }
}

function startMapLoadTimeout() {
  mapLoadTimeout = setTimeout(() => {
    const iframe = document.querySelector('.satellite-map iframe');
    const loadingDiv = document.getElementById('map-loading');
    if (loadingDiv && iframe.style.opacity !== '1') {
      loadingDiv.innerHTML = `
        <div class="map-error">
          <div class="error-icon">â°</div>
          <h4>Loading Timeout</h4>
          <p>The radar map is taking longer than expected to load.</p>
          <button class="retry-btn" onclick="retryMapLoad()">Try Again</button>
        </div>
      `;
    }
  }, 15000); // 15 second timeout
}

// Start timeout when page loads
window.addEventListener('load', function() {
  startMapLoadTimeout();
});

// Attempt to load by location on first visit for convenience
fetchByLocation();
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function() {
    navigator.serviceWorker.register("/static/service-worker.js");
  });
}
</script>
</body>
</html>